{{- with .Values.generic_clusterconfig }}
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: {{ .appsetname }}
  namespace: openshift-gitops
spec:
  generators:
  {{- if .clusterlist }}
    {{- range .clusterlist }}
      - clusters:
          selector:
            matchLabels:
              env: {{ .env }}
    {{- end }}
  {{- else }}
    - clusters: {}
  {{- end }}  
  template:
    metadata:
      name: >-
          {{ printf "{{ name }}-%s" .appsetname}}
    spec:
{{- end }}
{{- with .Values.general }}
      project: >-
        {{ printf "{{ name }}" }}
      source:
        helm:
          valueFiles:
            - in-cluster-values.yaml
        repoURL: {{ .source.repourl }}
        targetRevision: {{ .branch }}
{{- end }}
{{- with .Values.generic_clusterconfig }}
        path: {{ .path }}
      {{ if .autosync_enabled }}
      syncPolicy:
        automated:
          prune: {{ .syncpolicy_prune | default "false"  }}
          selfHeal: {{.syncpolicy_selfheal | default "false"  }}
      {{- end }}
      destination:
        server:  >-
          {{ printf "{{ server }}" }}
        namespace: default
{{- end }}
